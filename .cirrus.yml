freebsd_instance:
  image: freebsd-12-2-release-amd64
  cpu: 8
  memory: 16G

task:
  timeout_in: 320m
  sysinfo_script:
    - mount
    - df -h
    - sysctl hw.model hw.ncpu hw.physmem
    - freebsd-version

  install_script:
    - ASSUME_ALWAYS_YES=yes pkg bootstrap -f ; pkg upgrade -y
    - sed -i.bak -e 's,pkg+http://pkg.FreeBSD.org/\${ABI}/quarterly,pkg+http://pkg.FreeBSD.org/\${ABI}/latest,' /etc/pkg/FreeBSD.conf
    - pkg install -y bison postgresql12-server gmake libxml2 autoconf automake libtool pkgconf iconv pcre proj gdal sfcgal geos libxslt cunit protobuf-c json-c postgresql12-contrib

  patch_script:
    # will be removed
    - find . -name "*.pl" | xargs sed -i -r 's|/usr/bin/perl|/usr/bin/env perl|'
  configure_script:
    - ./autogen.sh
    - ./configure --without-libiconv-prefix --without-gui --without-interrupt-tests --with-topology --with-gdalconfig=/usr/local/bin/gdal-config --with-sfcgal=/usr/local/bin/sfcgal-config --with-address-standardizer --with-protobuf
    - service postgresql oneinitdb
    - service postgresql onestart
    - su -l postgres -c "createuser -s `whoami`"
  build_script:
    - gmake -j8
  check_script:
    - gmake -j8 check
    - gmake -j8 install
    - gmake -j8 check RUNTESTFLAGS="-v --extension"
    - gmake -j8 check RUNTESTFLAGS="-v --dumprestore"
  matrix:
    - name: freebsd11-amd64
      freebsd_instance:
        image: freebsd-11-4-release-amd64
    - name: freebsd12-amd64
      freebsd_instance:
          image: freebsd-12-2-release-amd64
    - name: freebsd13-amd64
      freebsd_instance:
          image: freebsd-13-0-release-amd64
    - name: freebsd14-amd64
      freebsd_instance:
          image_family: freebsd-14-0-snap
      env:
          CFLAGS: -isystem /usr/local/include -Wall -fno-omit-frame-pointer -Werror
          LIBS: -L/usr/local/lib
          LDFLAGS: -L/usr/local/lib
          PKG_CONFIG: /usr/local/bin/pkgconf
